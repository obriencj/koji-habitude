---
type: template
name: product
defaults:
  arches: [ x86_64 ]

content: |
  ---
  type: group
  name: {{ name }}-packagers
  permissions:
    - "{{ name }}-pkglist"
    - "{{ name }}-taggers"

  ---
  type: permission
  name: {{ name }}-pkglist
  description: "Can update package list for {{ name }}"

  ---
  type: permission
  name: {{ name }}-taggers
  description: "Can tag builds for {{ name }}"

  ---
  type: template
  name: {{ name }}-version
  defaults:
    name: {{ name }}
    version: "1.0"
    platforms: [ "fedora-42" ]
    arches: [ {{ ", ".join(arches) }} ]
  content: |
    {% raw %}
    {% set g = namespace() %}
    {% for platform in platforms %}
    {% set g.basetag = "-".join((name, version, platform)) %}
    ---
    type: tag
    name: {{ g.basetag }}-build
    locked: True
    permission: admin
    arches: [ {{ ", ".join(arches) }} ]

    inheritance:
      - name: {{ g.basetag }}-overrides
        priority: 0

      - name: {{ g.basetag }}-candidate
        priority: 5

      - name: {{ g.basetag }}-released
        priority: 10

      - name: {{ platform }}-build-base
        priority: 100

    ---
    type: tag
    name: {{ g.basetag }}-overrides
    permission: {{ name }}-taggers
    inheritance:
      - {{ g.basetag }}

    ---
    type: tag
    name: {{ g.basetag }}-candidate
    permission: {{ name }}-taggers
    inheritance:
      - {{ g.basetag }}

    ---
    type: tag
    name: {{ g.basetag }}-released
    permission: trusted
    inheritance:
      - {{ g.basetag }}

    ---
    type: tag
    name: {{ g.basetag }}
    locked: True
    permission: admin
    packages:
    {% if packages is defined and packages %}
    {% for package in packages %}
      {% if package is mapping %}
      - name: {{ package.get('name') }}
        {% if package.get('owner') is not none %}
        owner: {{ package.get('owner') }}
        {% endif %}
        {% if package.get('blocked') is not none %}
        blocked: {{ package.get('blocked') }}
        {% endif %}
        {% if package.get('extra-arches') is not none %}
        extra-arches: {{ package.get('extra-arches') }}
        {% endif %}
      {% else %}
      - {{ package }}
      {% endif %}
    {% endfor %}
    {% endif %}
    {% if packages_merge is defined and packages_merge %}
    {% for package_list in packages_merge %}
    {% for package in package_list %}
      {% if package is mapping %}
      - name: {{ package.get('name') }}
        {% if package.get('owner') is not none %}
        owner: {{ package.get('owner') }}
        {% endif %}
        {% if package.get('blocked') is not none %}
        blocked: {{ package.get('blocked') }}
        {% endif %}
        {% if package.get('extra-arches') is not none %}
        extra-arches: {{ package.get('extra-arches') }}
        {% endif %}
      {% else %}
      - {{ package }}
      {% endif %}
    {% endfor %}
    {% endfor %}
    {% endif %}

    ---
    type: target
    name: {{ g.basetag }}-candidate
    build-tag: {{ g.basetag }}-build
    dest-tag: {{ g.basetag }}-candidate

    {% endfor %}
    {% endraw %}

# The end.
